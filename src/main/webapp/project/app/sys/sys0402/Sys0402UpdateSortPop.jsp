<%/************************************************************************************************
* Description - Sys0402 - Menu
*   - Generated by Source Generator
************************************************************************************************/%>
<%@ include file="/shared/page/incCommon.jsp"%>
<%/************************************************************************************************
* Declare objects & variables
************************************************************************************************/%>
<%
	ParamEntity paramEntity = (ParamEntity)request.getAttribute("paramEntity");
	DataSet requestDataSet = (DataSet)paramEntity.getRequestDataSet();
	DataSet dsMenu = MenuManager.getMenuDataSet();
	DataSet dsMenu1 = MenuManager.getMenuDataSetByLevel(1);
	DataSet dsMenu2 = MenuManager.getMenuDataSetByLevel(2);
	SysUser sysUser = (SysUser)session.getAttribute("SysUser");
	String dateFormat = ConfigUtil.getProperty("format.date.java");
	String langCode = CommonUtil.upperCase((String)session.getAttribute("langCode"));
%>
<%/************************************************************************************************
* HTML
************************************************************************************************/%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link rel="icon" type="image/png" href="<tag:cp key="imgIcon"/>/favicon.png">
<title><tag:msg key="main.system.title"/></title>
<%/************************************************************************************************
* Stylesheet & Javascript
************************************************************************************************/%>
<%@ include file="/shared/page/incCssJs.jsp"%>
<style type="text/css">
#liDummy {display:none;}
#divDataArea.areaContainerPopup {padding-top:0px;}
.dummyMenu {list-style:none;margin-top:4px;}
.dragHandler {cursor:move;}
</style>
<script type="text/javascript">
$(function() {
	var langCode = globalMap.get("langCode").toUpperCase();
	var delimiter = globalMap.get("dataDelimiter");
	var dsMenu = commonJs.getDataSetFromJavaDataSet("<%=dsMenu.toStringForJs()%>");
	var dsMenu2 = commonJs.getDataSetFromJavaDataSet("<%=dsMenu2.toStringForJs()%>");

	/*!
	 * event
	 */
	$("#menuLevel").change(function(event) {
		var value = $(this).val();

		if (value == 2) {
			$("#divLevel1").css("display", "block");
			$("#divLevel2").css("display", "none");
		} else if (value == 3) {
			$("#divLevel1").css("display", "block");
			$("#divLevel2").css("display", "block");
		} else {
			$("#divLevel1").css("display", "none");
			$("#divLevel2").css("display", "none");
		}

		setLevel2Selectbox();
		refreshDataArea();
	});

	$("#level1").change(function(event) {
		setLevel2Selectbox();
		refreshDataArea();
	});

	$("#level2").change(function(event) {
		refreshDataArea();
	});

	$("#btnSave").click(function(event) {
		commonJs.confirm({
			contents:"<tag:msg key="Q001"/>",
			buttons:[{
				caption:"Yes",
				callback:function() {
					commonJs.ajaxSubmit({
						url:"/sys/0402/exeUpdateSortOrder.do",
						dataType:"json",
						formId:"fmDefault",
						data:{
							dataLength:$("#ulMenuHolder .dummyMenu").length
						},
						success:function(data, textStatus) {
							var result = commonJs.parseAjaxResult(data, textStatus, "json");

							if (result.isSuccess == true || result.isSuccess == "true") {
								commonJs.openDialog({
									type:"information",
									contents:result.message,
									blind:true,
									buttons:[{
										caption:"Ok",
										callback:function() {
											parent.popup.close();
											parent.doSearch();
										}
									}]
								});
							} else {
								commonJs.error(result.message);
							}
						}
					});
				}
			}, {
				caption:"No",
				callback:function() {
				}
			}]
		});
	});

	$("#btnClose").click(function(event) {
		parent.popup.close();
	});

	/*!
	 * process
	 */
	setLevel2Selectbox = function() {
		var level1MenuId = $("#level1").val();

		$("#level2").find("option").remove();
		for (var i=0; i<dsMenu2.getRowCnt(); i++) {
			var parentMenu = dsMenu2.getValue(i, "PARENT_MENU_ID");
			if (parentMenu == level1MenuId) {
				$("#level2").append("<option value=\""+dsMenu2.getValue(i, "MENU_ID")+"\">"+dsMenu2.getValue(i, "MENU_ID")+"</option>");
			}
		}
		$("#level2").selectpicker("refresh");
	};

	refreshDataArea = function() {
		var menuLevel = $("#menuLevel").val();
		var level1MenuId = $("#level1").val();
		var level2MenuId = $("#level2").val();

		$("#ulMenuHolder").empty();

		for (var i=0; i<dsMenu.getRowCnt(); i++) {
			if (dsMenu.getValue(i, "MENU_ID") == "QM") {
				continue;
			}

			if (menuLevel == 1) {
				if (dsMenu.getValue(i, "LEVEL") == 1) {
					renderElement(i);
				}
			} else if (menuLevel == 2) {
				if (dsMenu.getValue(i, "LEVEL") == 2 && dsMenu.getValue(i, "PARENT_MENU_ID") == level1MenuId) {
					renderElement(i);
				}
			} else if (menuLevel == 3) {
				if (dsMenu.getValue(i, "LEVEL") == 3 && dsMenu.getValue(i, "PARENT_MENU_ID") == level2MenuId) {
					renderElement(i);
				}
			}
		}

		$("#ulMenuHolder").find(".dummyMenu").each(function(groupIndex) {
			$(this).find("input[type=text]").each(function(index) {
				var id = $(this).attr("id"), name = $(this).attr("name");

				if (!commonJs.isEmpty(id)) {id = (id.indexOf(delimiter) != -1) ? id.substring(0, id.indexOf(delimiter)) : id;}
				else {id = "";}

				if (!commonJs.isEmpty(name)) {name = (name.indexOf(delimiter) != -1) ? name.substring(0, name.indexOf(delimiter)) : name;}
				else {name = "";}

				$(this).attr("id", id+delimiter+groupIndex).attr("name", name+delimiter+groupIndex);
			});
		});
	};

	renderElement = function(dsIndex) {
		var elem = $("#liDummy").clone();

		$(elem).css("display", "block").appendTo($("#ulMenuHolder"));
		$(elem).find("input[type=text]").each(function(index) {
			if ($(this).attr("id") == "menuId") {
				$(this).val(dsMenu.getValue(dsIndex, "MENU_ID"));
			}

			if ($(this).attr("id") == "menuName") {
				$(this).val(dsMenu.getValue(dsIndex, "MENU_NAME_"+langCode));
			}

			if ($(this).attr("id") == "sortOrder") {
				$(this).val(dsMenu.getValue(dsIndex, "SORT_ORDER"));
			}
		});
	};

	setSortable = function() {
		$("#ulMenuHolder").sortable({
			axis:"y",
			handle:".dragHandler",
			stop:function() {
				var menuLevel = $("#menuLevel").val();
				var level1MenuId = $("#level1").val();
				var level2MenuId = $("#level2").val();

				$("#ulMenuHolder").find(".dummyMenu").each(function(groupIndex) {
					$(this).find("input[type=text]").each(function(index) {
						var id = $(this).attr("id"), name = $(this).attr("name");

						if (!commonJs.isEmpty(id)) {id = (id.indexOf(delimiter) != -1) ? id.substring(0, id.indexOf(delimiter)) : id;}
						else {id = "";}

						if (!commonJs.isEmpty(name)) {name = (name.indexOf(delimiter) != -1) ? name.substring(0, name.indexOf(delimiter)) : name;}
						else {name = "";}

						$(this).attr("id", id+delimiter+groupIndex).attr("name", name+delimiter+groupIndex);

						if (name.indexOf("sortOrder") != -1) {
							if (menuLevel == 1) {
								$(this).val(commonJs.lpad((groupIndex+1), 2, "0")+"0000");
							} else if (menuLevel == 2) {
								var level1Sort = commonJs.nvl(dsMenu.getValue(dsMenu.getRowIndex("MENU_ID", level1MenuId), "SORT_ORDER"), "000000");

								level1Sort = level1Sort.substring(0, 2);
								$(this).val(level1Sort + commonJs.lpad((groupIndex+1), 2, "0")+"00");
							} else if (menuLevel == 3) {
								var level2Sort = commonJs.nvl(dsMenu.getValue(dsMenu.getRowIndex("MENU_ID", level2MenuId), "SORT_ORDER"), "000000");

								level2Sort = level2Sort.substring(0, 4);
								$(this).val(level2Sort + commonJs.lpad((groupIndex+1), 2, "0"));
							}
						}
					});
				});
			}
		});

		$("#ulMenuHolder").disableSelection();
	};

	/*!
	 * load event (document / window)
	 */
	$(window).load(function() {
		$("#level1").selectpicker({width:"80px"}).selectpicker("refresh");
		$("#level2").selectpicker({width:"90px"}).selectpicker("refresh");
		commonJs.getBootstrapSelectbox("menuLevel").focus();
		setLevel2Selectbox();
		refreshDataArea();
		setSortable();
	});
});
</script>
</head>
<%/************************************************************************************************
* Page & Header
************************************************************************************************/%>
<body>
<form id="fmDefault" name="fmDefault" method="post" action="">
<div id="divPopupWindowHolder">
<div id="divFixedPanelPopup">
<div id="divLocationPathArea"><%@ include file="/project/common/include/bodyLocationPathArea.jsp"%></div>
<%/************************************************************************************************
* Real Contents - fixed panel(tab, button, search, information)
************************************************************************************************/%>
<div id="divTabArea"></div>
<div id="divButtonArea" class="areaContainerPopup">
	<div id="divButtonAreaLeft"></div>
	<div id="divButtonAreaRight">
		<tag:buttonGroup id="buttonGroup">
			<tag:button id="btnSave" caption="button.com.save" iconClass="fa-save"/>
			<tag:button id="btnClose" caption="button.com.close" iconClass="fa-times"/>
		</tag:buttonGroup>
	</div>
</div>
<div id="divSearchCriteriaArea"></div>
<div id="divInformArea" class="areaContainerPopup">
	<div class="panel panel-default">
		<div class="panel-body">
			<div id="divMenuLevel" style="float:left;padding-right:4px;">
				<label for="menuLevel" class="lblEn hor"><tag:msg key="sys0402.header.menuLevel"/></label>
				<tag:select id="menuLevel" name="menuLevel" codeType="MENU_LEVEL" caption="" className="bootstrapSelect default"/>
			</div>
			<div class="horGap70"></div>
			<div id="divLevel1" style="float:left;display:none;">
				<label for="level1" class="lblEn hor"><tag:msg key="sys0402.header.level1"/></label>
				<select id="level1" name="level1" class="bootstrapSelect default">
<%
				for (int i=0; i<dsMenu1.getRowCnt(); i++) {
					if (!CommonUtil.equals(dsMenu1.getValue(i, "MENU_ID"), "QM")) {
%>
				<option value="<%=dsMenu1.getValue(i, "MENU_ID")%>"><%=dsMenu1.getValue(i, "MENU_ID")%></option>
<%
					}
				}
%>
				</select>
			</div>
			<div class="horGap30"></div>
			<div id="divLevel2" style="float:left;display:none;">
				<label for="level2" class="lblEn hor"><tag:msg key="sys0402.header.level2"/></label>
				<select id="level2" name="level2" class="bootstrapSelect default">
				</select>
			</div>
		</div>
	</div>
</div>
<%/************************************************************************************************
* End of fixed panel
************************************************************************************************/%>
<div class="breaker"></div>
</div>
<div id="divScrollablePanelPopup">
<%/************************************************************************************************
* Real Contents - scrollable panel(data, paging)
************************************************************************************************/%>
<div id="divDataArea" class="areaContainerPopup">
	<ul id="ulMenuHolder"></ul>
</div>
<div id="divPagingArea"></div>
<%/************************************************************************************************
* Right & Footer
************************************************************************************************/%>
</div>
</div>
<%/************************************************************************************************
* Additional Elements
************************************************************************************************/%>
<li id="liDummy" class="dummyMenu">
	<table class="tblEdit">
		<colgroup>
			<col width="3%"/>
			<col width="15%"/>
			<col width="*"/>
			<col width="15%"/>
		</colgroup>
		<tr>
			<th id="thDragHander" class="thEditCt dragHandler" title="<tag:msg key="sys0402.msg.drag"/>"><i id="iDragHandler" class="fa fa-lg fa-sort"></i></th>
			<td class="tdEdit"><input type="text" id="menuId" name="menuId" class="txtDpl" readonly/></td>
			<td class="tdEdit"><input type="text" id="menuName" name="menuName" class="txtDpl" readonly/></td>
			<td class="tdEdit"><input type="text" id="sortOrder" name="sortOrder" class="txtDpl" readonly/></td>
		</tr>
	</table>
</li>
</form>
<%/************************************************************************************************
* Additional Form
************************************************************************************************/%>
<form id="fmHidden" name="fmHidden" method="post" action=""></form>
</body>
</html>